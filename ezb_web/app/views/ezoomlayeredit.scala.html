@(ezoombook:Ezoombook, ezlForm:Form[EzoomLayer], bookOpt:Option[Book])(implicit context:Context)

@import helper._
@import utils.EzbHelpers._
@import ezbhelper._


@displayPart(part:Field) = {
    <fieldset class="part_field">
    @inputText(part("part_title"), '_label -> "", 'class -> "part_title")
    @hidden(part("contrib_type"), 'value -> "contrib.Part")
    @repeat(part("part_contribs")){pc =>
        @pc("contrib_type").value.map{ct =>
            @displayAtomic(ct,pc,"part_")
        }.getOrElse{
            <p>Cannot display part content</p>
        }
    }
    </fieldset>
}

@displayAtomic(ctype:String, c:Field, level:String) = {
    @ctype match{
        case "contrib.Quote" => {
             @hidden(c("contrib_type"), 'value -> "contrib.Quote")
             @textarea(c("contrib_content"), '_label -> "", 'class -> "quote")
        }
        case "contrib.Summary" => {
            @hidden(c("contrib_type"), 'value -> "contrib.Summary")
            @textarea(c("contrib_content"), '_label -> "", 'class -> (level+"summary"))
        }
        case _ => {
            <p>Could not display contribution. Unknown type @ctype</p>
        }
    }
}

@levelMap(body: (Map[String,String]) => Html ) = {
    @defining(Map("1"->"Higly Detailed", "2"->"Fairly Detailed", "3"->"Fairly Abridged", "4"->"Highly Abridged")){lmap =>
        @body(lmap)
    }
}

@displayEzbInfo(ezb:Ezoombook) = {
    <dl>
        <dt>Title:</dt><dd>@ezb.ezoombook_title</dd>
        <dt>Is Public:</dt><dd>@ezb.ezoombook_public</dd>
        <dt>Status:</dt><dd>@ezb.ezoombook_status</dd>
        <dt>Layers</dt>
        <ul>
        @ezb.ezoombook_layers.map{layer =>
            @levelMap{lmap =>
            <li><a href="/ezlayer/edit/@ezb.ezoombook_id/@layer._2">@lmap.getOrElse(layer._1, "undef")</a></li>
            }
        }
        </ul>
        <dt><a href="/ezb/edit/@ezb.ezoombook_id">Add a layer...</a></dt><dd></dd>
    </dl>
}

@scripts = {
<script type="text/javascript">//<![CDATA[
    $(document).ready(function(){
        $('#btnAddezbSummary').click(function () {
            createField("ezb_summary", "textarea", "ezoomlayer_summaries", "", "summaries_set")
        });
        $('#btnAddSummary').click(function () {
            addContrib("summary")
        });
        $('#btnAddPart').click(function () {
            addContrib("part")
        });
    });
//]]>
</script>
}

@main("Ezoombook Edition", scripts){
<style>
.leftpannel{
  position: absolute;
  top: 130px;
  right: 75%;
}
.ezoomlayer{
  position: absolute;
 top: 170px;
  left: 30%;
  
  
}
.field
{
    border:2px solid blue;
    -moz-border-radius:8px;
    -webkit-border-radius:8px;
    border-radius:8px;
}
.ezb_summary
{
 width: 89%; 
}

.quote
{
 width: 89%; 
}
.contrib_summary
{
 width: 89%; 
}
</style>
    <div class="row">
        <div class="span12">
            <h1>eZoomBook Edition</h1>
        </div>
    </div>
    <div class="row">
        <div class="span3">
            <div>
                <h3 id="ezoombook_title">eZoomBook Info</h3>
                @displayEzbInfo(ezoombook)

                <p>Load a layer from a file: </p>
                @form(routes.EzoomBooks.loadEzoomLayer(ezoombook.ezoombook_id.toString), 'enctype -> "multipart/form-data"){
                    <input type="file" name="ezlfile"></br>
                    <input type="submit">
                }
            </div>
            @bookOpt.map{book =>
            <div>
                <h3 id="book_info_header">Book Info</h3>
                <dl>
                    <dt>Title:</dt><dd>@book.bookTitle</dd>
                    <dt>Author(s):</dt><dd>@book.bookAuthors.mkString(",")</dd>
                    @ezlForm.value.map{ezl =>
                        <dt><a href="/bookread/@book.bookId/0">Navigate this book... </a> </dt><dd></dd>
                    }.getOrElse{
                        <dt><a href="/bookread/@book.bookId/0">Navigate this book... </a> </dt><dd></dd>
                    }
                </dl>
            </div>
            }.getOrElse{<div>Please specify a book!</div>}
        </div>
        <div class="span9">
            @if(ezlForm.hasErrors){
            <div class="alert alert-error">
                <a class="close" data-dismiss="alert">x</a>
                <p>It seems there are some errors in your request...</p>
                <ul>
                @ezlForm.errors.map{err =>
                    <li>@err.key : @err.message</li>
                }
                </ul>
            </div>
            }
            @form(routes.EzoomBooks.saveEzoomlayer(ezoombook.ezoombook_id.toString), 'id -> "ezl_form"){
            <fieldset class="field">
                <legend>eZoomLayer</legend>
                @hidden(ezlForm("ezoomlayer_id"))
                @hidden(ezlForm("ezoombook_id"))
                @hidden(ezlForm("ezoomlayer_owner"))
                <div class="save">
                    <input type="submit" value="Save eZoomLayer">
                </div>
                <div>
                    @levelMap{lmap =>
                        @select(ezlForm("ezoomlayer_level"), options = for(i <- 1 to 4) yield(i.toString -> lmap(i.toString)),
                        '_label -> "Level:")
                    }
                </div>
                <div>
                    @checkbox(ezlForm("ezoomlayer_locked"), '_label -> "Locked")
                </div>
                <div>
                    @checkbox(ezlForm("ezoomlayer_status"), '_label -> "Mark as published")
                </div>
                <div class="btn-group">
                    <input type="button" class="btn" id="btnAddezbSummary" value="+ Book Summary">
                    <input type="button" class="btn" id="btnAddSummary" value="+ Summary">
                    <input type="button" class="btn" id="btnAddPart" value="+ Part">
                </div>
            </fieldset>
            <fieldset id="summaries_set" class="field">
                <legend>Book Summaries</legend>
                @repeat(ezlForm("ezoomlayer_summaries"), min = 0){f =>
                    @textarea(f, '_label -> "", 'class -> "ezb_summary")
                 
                }
            </fieldset>
            <fieldset id="contribs_set" class="field">
                <legend>Contributions</legend>
                @repeat(ezlForm("ezoomlayer_contribs")){f =>
                    @hidden(ezlForm("contrib_id"))
                    @hidden(ezlForm("ezoomlayer_id"))
                    @hidden(ezlForm("ezoombook_id"))
                    @hidden(ezlForm("user_id"))
                    @hidden(ezlForm("contrib_part"))
                    @hidden(ezlForm("contrib_status"))
                    @hidden(ezlForm("contrib_locked"))

                    @f("contrib_type").value.map{cf =>
                        <div class="contrib">
                            @cf match{
                            case "contrib.Part" => { @displayPart(f) }
                            case _ => { @displayAtomic(cf, f, "contrib_") }
                            
                            }
                        </div>
                    }.getOrElse{ }
                }
                
            </fieldset>

            }
        </div>
    </div>
}



